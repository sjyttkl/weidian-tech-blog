<style>
.sidebar,
.sidebar-toggle {
    display: none;
}
.markdown-section h1,
.markdown-section h2,
.markdown-section h3 {
    text-align: center;
    padding-bottom: 20px;
    border-bottom: 1px solid #ccc;
}

.markdown-section h3 {
    text-align: left;
    border-bottom: 0;
}
/* 覆盖腾讯企业邮箱的设置 */
.content {
    position: relative !important;
    left: 0;
}

main {
    height: auto !important;
}

img {
    width: 100%;
    margin-bottom: 10px;
}
</style>

<h1 style="text-align: center;">全栈化技术周刊 第 21 期（2019/06/21）</h1>

<div class="img-list">
    <img src="https://si.geilicdn.com/img-20ac0000016b7923e7ac0a21167e_11142_4303.jpg" />
</div>

<!-- <p style="text-align: center;"><a href="http://spaceengine.org/download/spaceengine/">Space Engine</a> 在 Steam 正式上线</p> -->

<h2 style="text-align: center;">关于</h2>

全栈化技术周刊整理每周有趣有用有料的各类内容，为大家呈现多样的技术世界。

**周刊编辑：@何会会 / @张尚金 / @杨力 / @赵兴 / @刘远洋**

**周刊招募内容作者，主题不限，向团队发出你的声音吧！**

<h2 style="text-align: center;">见闻</h2>

- 北京时间 6 月 12 日凌晨，有“互联网女皇”之称的玛丽·米克尔发布了 2019 年的互联网趋势报告，这也是她第 24 年公布互联网报告，报告指出了互联网人口红利持续衰减、非洲、中东或是“新大陆”、中美垄断互联网头部公司等十大要点。

  https://36kr.com/p/5214606

* 一行代码的 npm 软件包 “is-windows” 有 250 万依赖者，究竟为什么?!

  https://twitter.com/caspervonb/status/1139947676546453504

* 美国一黑熊因与人过亲被安乐死，工作人员：如果与人类接触没那么频繁可能会安置到别的地方

  近日，一只幼年黑熊被实施安乐死，原因竟是因为它太过经常与人类亲近。由于经常有人投喂这只黑熊，甚至与其拍摄自拍照，这在当地警方看来是一种“潜在危险”，因而不得不对其实施安乐死。关于这只被安乐死的小熊，俄勒冈州鱼类和野生动物部工作人员向 CNN 表示，它重约 100 磅，年龄在 2 到 3 岁之间。此外，该工作人员还透露，如果这只小熊与人类的接触没有那么频繁，当初它可能会被安置到其他地方。

  此外，野生动物生物学家科特表示，这与人类的喂食有关。“这是一个典型的例子，说明了为什么我们呼吁公众不要给熊喂食，”科特说，“喂养野生动物（更不用说拍一张特写照片）不仅对人类来说是危险的，对熊来说也是有害的，”他解释说，因为当熊习惯被人喂食后，它们常常会被一些人类丢弃的食物垃圾吸引，如未经过妥善处理，这些垃圾会使熊染上疾病。

* 德国妹子坚持跑步 20 周完成的成功蜕变，希望这个影片能激励你：不坚持到最后你永远不知道自己能有多大改变，加油！

  https://weibo.com/tv/v/HypFBoqt4?fid=1034:4382017383542271

<h2 style="text-align: center;">分享</h2>

- 还可以这么玩？超实用 Typescript 内置类型与自定义类型

  https://segmentfault.com/a/1190000019402237

- rga 是 ripgrep 超强版，另添搜索 PDF，电子书，Office 文档，zip，tar.gz 等功能。

  https://phiresky.github.io/blog/2019/rga--ripgrep-for-zip-targz-docx-odt-epub-jpg/

- GMTC 大会部分 PPT：

  https://ppt.geekbang.org/list/gmtcbj2019

- 最怕面试官问一些细节问题，这里面包含了 43 个常见面试问题，了解一下？

  https://github.com/lydiahallie/javascript-questions/blob/master/README-zh_CN.md

- 有了`readme-md-generator`这个自动生成 README 文件的工具， 再也不用为写项目介绍文档而发愁了

  https://github.com/kefranabg/readme-md-generator?utm_campaign=explore-email&utm_medium=email&utm_source=newsletter&utm_term=weekly

- 2019 年最新总结，从程序员到 CTO，从专业走向卓越，分享大牛企业内部 pdf 与 PPT

  https://github.com/0voice/from_coder_to_expert?utm_campaign=explore-email&utm_medium=email&utm_source=newsletter&utm_term=weekly

-  全栈开发工程师（又称全干工程师），优秀的全干开发工程师都是怎样  做事的呢？这里有一些经验供你参考

  https://medium.com/@eliezer/how-writing-simple-javascript-got-us-6200-github-stars-in-a-single-day-420b17b4cff4

- CSS 能干的事情永远比你想象的要多，这篇文章介绍了如何通过 CSS 来完成例如 Dialog（模态框）、Tabs（标签页）、Collapse（折叠面板）、LightBox（图片  预览）等交互效果

  https://juejin.im/post/5d0b76d8f265da1b602909c5

- 移动端适配，大家平时肯定都遇到过，你可能用的是现成的库或者工具来完成，那你有真正了解过这里的细节都有哪些么，看完这篇文章，相信你会有更深了解

  https://juejin.im/post/5cddf289f265da038f77696c

* 多吉搜索是一个新的国产搜索引擎，据称目标是成为百度的替代方案之一。

  https://dogedoge.com/

  ![image](https://user-images.githubusercontent.com/5757051/59909239-c88d4f80-9441-11e9-80e9-c1bf5211b94d.png)

* 分享 GitHub 上有趣、入门级的开源项目「每月 28 号更新」

  https://github.com/521xueweihan/HelloGitHub

* Flutter 淘宝 App

  让一部分人先看见未来

  https://github.com/GanZhiXiong/GZXTaoBaoAppFlutter

* 美团：保障 IDC 安全：分布式 HIDS 集群架构设计

  https://tech.meituan.com/2019/01/17/distributed-hids-cluster-architecture-design.html

<h2 style="text-align: center;">投稿</h2>

<h3 style="text-align: center;">为什么策略一上线就超时</h3>

<div style="text-align: center;">@苏立威01</div>

原文：http://docs.vdian.net/pages/viewpage.action?pageId=77932506

<h3 style="text-align: center;">一、策略上线超时</h3>

现象:策略在预发测试正常,上线后微店 app 访问结果有 70%的概率访问失败,提示“系统累了”.

<img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59903807-7d207480-9434-11e9-8863-8dd03ef849f2.png" />

<h3 style="text-align: center;">二、排查过程</h3>

- 步骤一. app 排查

  app 端排查结果: pluto 返回 "plutoException" 异常.(app 通过 dubbo 访 问,预发测试通过 http 访问)

- 步骤二. vtrace 观察

  1.vrace 排查, pluto 请求过程耗时超过 500ms.

  2.pluto 在策略耗时超过 500ms 会返回 plutoException 结果给调用方

- 步骤三. 推荐策略增加 debug 代码,优化 redis

  1. 发现 redis 查询模块代码耗时特别大.

  2. redis 同学建议单个 key,value 不要超过 10k,本次 redis 单个 key 保存的值为 200k,10k 以后非常不稳定

  3. 算法拆分原来 200k 为 40k,预发测试通过,线上测试通过.

结论: 看起来一切都解决了,然而还是有遗留问题.

**???为什么预发环境测试没发现问题,一上线就出问题.预发环境和线上环境用的同一套 redis.**

<img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59903892-bf49b600-9434-11e9-88ff-2753075b1c7f.png" />

<h3 style="text-align: center;">三、复盘测试</h3>

由于当时时间比较紧张,为什么预发测试没问题,线上就有问题.这个问题一直没答案.以下进行对比测试.

- 步骤一. redis 测试

  预发环境: redis 平均 rt 3ms,偶尔有 60ms, 但是整体策略时间控制在 100ms 内

  http://pluto.pre.vdian.net/solution/query?debug=true&pageIndex=10&solutionId=1053&userId=1094531703

  线上环境: redis 平均 rt 3ms, 偶尔有 60ms, 但是整体策略时间控制在 100ms 内.与线上环境一致.

  http://10.32.179.98:8080/solution/query?debug=true&pageIndex=10&solutionId=1053&userId=1094531703

- 步骤二. solutionId 访问和 businessId 访问是否有影响

  预发 businessId 访问:与预发 solution 一致.

  http://pluto.pre.vdian.net/recommend?debug=true&pageIndex=10&businessId=310&userId=1094531703"

  线上 businessId 访问:与线上 solution 一致.

  http://10.32.179.96:8080/recommend?debug=true&pageIndex=10&businessId=310&userId=1094531703"

  为了方便单机统计 log, 这里线上 business 使用了 ip 访问的方式, 埋了巨坑。

  <img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59903981-f8822600-9434-11e9-9510-5f8c638577a5.png" />

- 步骤三. app 再次测试

  将 1053 增加到 ab 计划, 配置白名单, 线上测试没发现超时情况, 为什么又没问题了.

  <img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59904068-29faf180-9435-11e9-84c5-821453f89188.png" />

<h3 style="text-align: center;">四、冷启动</h3>

1.  冷启动介绍

    从复盘测试中发现: 原来的代码并没有问题, 这个时候突然想起冷启动.

    > java 冷启动: 当 JVM 启动时，不会加载任何内容。会首先加载正在执行的程序的类文件，然后加载其他正在执行的字节码中被引用的类和接口。因此，JVM 表现出延迟加载特性.

    <img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59904124-4e56ce00-9435-11e9-8ad6-1cb47be5d105.png" />

    猜想:之前的失败是没有流量预热导致.

    当系统访问未加载的类需要一定的耗时用来加载,pluto 在超过 500ms 后也会强制杀死进程,导致可能一次预热不一定成功.

2.  验证冷启动的影响

    步骤一、增加一些不重要的 debug 信息,重修提交策略 1053

    步骤二、线上请求 1000 次该接口用域名的方式

    http://pluto.vdian.net/recommend?debug=true&pageIndex=10&businessId=310&userId=1094531703"

    步骤三、重新通过 app 验证视频推荐业务,线上不在出现系统累了.

    <img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59904161-6c243300-9435-11e9-8598-a3db64848a75.png" />

<h3 style="text-align: center;">五、如何避免</h3>

上线一定要预热.

上线一定要预热.

上线一定要预热.

<img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59904193-7f370300-9435-11e9-8963-ad04c76ba45e.png" />

<h3 style="text-align: center;">六、一些其他坑</h3>

预发环境只有一台机器,所以一次请求就能预热了.线上有 56 台机器,没有预热的话线上访问会时好时坏.

前段时间已经提需求给开发做了策略发布预热功能,但是 pluto 由于都要迁移到 njord,目前 pluto 预热操作,全靠开发的自觉.

由于负载均衡的算法并不是完全平均,就算预热 1000 次了,可能还会存在部分机器没预热到,系统还是有较小概率累了.

redis 查询语句执行慢,可能是真的 redis 查询慢也可能是 redis 相关语句在冷启动.

<img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59904241-9d9cfe80-9435-11e9-96fb-72e370ae3af5.png" />

<h3 style="text-align: center;">后记</h2>

整个排查过程大概是这样.

<img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59904266-a7266680-9435-11e9-969e-47fbdbaa405c.png" />

发布不规范,测试两行泪

<img style="width: 30%; margin: 0 auto;" src="https://user-images.githubusercontent.com/5757051/59904285-b1486500-9435-11e9-8769-441323cb082b.png" />
